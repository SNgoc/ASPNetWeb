using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Data.SqlClient;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace DemoTabs
{
    public partial class Form1 : Form
    {
        const string conStr = "Server=.;DataBase = T12008M0; User = sa; Password=merlin3103";
        SqlConnection con;
        SqlDataAdapter adapter;
        DataSet ds;
        DataTable tbBook;
        BindingSource bs;
        DataView dvSearch;//tạo view tìm kiếm trong data gridview
        public Form1()
        {
            InitializeComponent();
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            con = new SqlConnection(conStr);
            string query = "SELECT * FROM Book";
            adapter = new SqlDataAdapter(query, con);
            //sinh câu insert, update, delete
            SqlCommandBuilder builder = new SqlCommandBuilder(adapter);
            adapter.InsertCommand = builder.GetInsertCommand();
            adapter.UpdateCommand = builder.GetUpdateCommand();
            adapter.DeleteCommand = builder.GetDeleteCommand();

            ds = new DataSet();
            adapter.Fill(ds, "Book");
            tbBook = ds.Tables["Book"];
            bs = new BindingSource();
            bs.DataSource = tbBook;

            gvBooks.DataSource = bs;//view book

            //binding data to textbox control
            //update book
            textUID.DataBindings.Add("Text", bs, "Id");
            textUID.ReadOnly = true;//ko cho phép đổi ID khi update
            textUTitle.DataBindings.Add("Text", bs, "Title");
            textUPrice.DataBindings.Add("Text", bs, "Price");

            //xử lý hiển thị tất cả records cho form search
            dvSearch = new DataView(tbBook);//khởi tạo dataview gắn vào đối tượng tbBook (dòng 44)
            gvSBook.DataSource = dvSearch;
        }

        private void btnUpdate_Click(object sender, EventArgs e)
        {
            adapter.Update(ds, "Book");//LƯU THAY  ĐỔI
        }

        private void btnSearch_Click(object sender, EventArgs e)
        {
            dvSearch.RowFilter = "Title LIKE '%" + textSTitle.Text + "%'";
        }

        private void btnCreate_Click(object sender, EventArgs e)
        {
            int id = Convert.ToInt32(textID.Text);
            string title = textTilte.Text;
            int price = Convert.ToInt32(textPrice.Text);

            //tạo mới record thông qua binding source
            bs.AddNew();
            var row = ((DataRowView)bs.Current).Row;
            row[0] = id;
            row[1] = title;
            row[2] = price;
            bs.EndEdit(); //hoàn thành update, sẽ thay đổi data trong db
            //lưu thay đổi vào db
            adapter.Update(ds, "Book");//LƯU THAY  ĐỔI
        }
    }
}
